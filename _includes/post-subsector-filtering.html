<!-- Get the posts first, and then display them according to subsector -->
{% assign sectorPosts = include.posts | where_exp:"post","post.sectors contains include.sector" %}
{% assign subsectors = site.subsectors | where_exp:"subsector","subsector.sector == include.sector" %}

<!-- Archive Link -->
{% capture archiveLink %}{% if include.state %}states/{{ include.state | slugify }}/{{ include.sector | slugify }}{% else %}sectors/{{ include.sector | slugify }}{% endif %}{% endcapture %}

<!-- Display Subsector Filtering if we have articles in this sector -->
{% if sectorPosts %}
  <ul>
    <li><a href="#subsector=all" class="subsector-link" data-show-subsector="{{ include.sector | slugify }}-all" data-sector="{{ include.sector | slugify }}">All</button></li>
    {% for subsector in subsectors %}
      <li><a href="#subsector={{ subsector.title | slugify }}" class="subsector-link" data-show-subsector="{{ subsector.title | slugify }}" data-sector="{{ include.sector | slugify }}">{{ subsector.title }}</button></li>
    {% endfor %}
  </ul>

  <!-- Post Sorting, Rendering, and Pagination -->
  <div class="sort-attributes-container">
    <a href="#subsector=all&amp;sort=date&amp;order=asc" class="sort-attribute" data-sort="sort=date&amp;order=asc">Date Ascending</a> &middot; 
    <a href="#subsector=all&amp;sort=date&amp;order=desc" class="sort-attribute active" data-sort="sort=date&amp;order=desc">Date Descending</a> &middot; 
    <a href="#subsector=all&amp;sort=state&amp;order=asc" class="sort-attribute" data-sort="sort=state&amp;order=asc">State Ascending</a> &middot; 
    <a href="#subsector=all&amp;sort=state&amp;order=desc" class="sort-attribute" data-sort="sort=state&amp;order=desc">State Descending</a>
  </div>
  <div class="pagination-posts-container post-listing" data-sector="{{include.sector | slugify}}" data-subsector="all"></div>
  <div class="pagination-container"></div>

  <!-- Create Initial Posts Object -->
  <script type="text/javascript">
    var postsPaginateMainObject = {};
    var postsPaginateSecondaryObject = {};
    var postsPaginateSecondaryTotal = {};
    var posts_per_page = {{ site.post_archive_posts_per_page }};
    var subsectorFiltering = true;

    // Load all posts JSON for this State / Sector
    postsPaginateMainObject["all"] = [
      {% for post in sectorPosts %}
        {% capture states %}[{% for state in post.states %}"{{state}}"{% unless forloop.last %},{% endunless %}{% endfor %}]{% endcapture %}
        {% capture sectors %}[{% for sector in post.sectors %}"{{sector}}"{% unless forloop.last %},{% endunless %}{% endfor %}]{% endcapture %}
        {% capture postSubsectors %}[{% for subsector in post.subsectors %}"{{subsector}}"{% unless forloop.last %},{% endunless %}{% endfor %}]{% endcapture %}
        {% capture postHtml %}{% include post-listing-post.html %}{% endcapture %}
        {
          "id": "{{ post.title | escape | slugify }}",
          "title": "{{ post.title }}",
          "states": {{states}},
          "sectors": {{sectors}},
          "subsectors": {{postSubsectors}},
          "url": "{{ post.url | relative_url }}",
          "date": new Date("{{ post.date | date_to_xmlschema }}"),
          "dateFormatted": "{{ post.date | date: site.date_format }}",
          "excerpt": "{{ post.excerpt | replace: '"', '\"' | normalize_whitespace }}",
          "postHtml": {{postHtml | strip_newlines | jsonify}}
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ];

    postsPaginateSecondaryObject["all"] = [];
    postsPaginateMainObject["all"].forEach(function(post, pIndex) {
      post.states.forEach(function(state, index){
        var newPost = {
          "id": post.id,
          "title": post.title,
          "states": post.states,
          "sectors": post.sectors,
          "state": state,
          "subsectors": post.subsectors,
          "url": post.url,
          "date": post.date,
          "dateFormatted": post.dateFormatted,
          "excerpt": post.excerpt,
          "postHtml": post.postHtml
        };
        postsPaginateSecondaryObject["all"].push(newPost);

        // Increment Total
        postsPaginateSecondaryTotal[state] = {"all":1} || [];
        postsPaginateSecondaryTotal[state]["all"] = postsPaginateSecondaryTotal[state]["all"] + 1 || 1;
      });
    });
    console.log(postsPaginateSecondaryTotal);
  </script>

  <!-- Filter Posts by Subsector -->
  {% for subsector in subsectors %}
    {% assign subsectorPosts = sectorPosts | where_exp:"post","post.subsectors contains subsector.title" %}
    {% assign subsectorSlug = subsector.title | slugify %}

    {% for post in subsectorPosts %}
      <script type="text/javascript">
        // Load all posts JSON grouped by subsector
        postsPaginateMainObject["{{subsectorSlug}}"] = [
          {% for post in subsectorPosts %}
            {% capture states %}[{% for state in post.states %}"{{state}}"{% unless forloop.last %},{% endunless %}{% endfor %}]{% endcapture %}
            {% capture sectors %}[{% for sector in post.sectors %}"{{sector}}"{% unless forloop.last %},{% endunless %}{% endfor %}]{% endcapture %}
            {% capture subsectors %}[{% for subsector in post.subsectors %}"{{subsector}}"{% unless forloop.last %},{% endunless %}{% endfor %}]{% endcapture %}
            {% capture postHtml %}{% include post-listing-post.html %}{% endcapture %}
            {
              "id": "{{ post.title | escape | slugify }}",
              "title": "{{ post.title }}",
              "states": {{states}},
              "sectors": {{sectors}},
              "subsectors": {{subsectors}},
              "url": "{{ post.url | relative_url }}",
              "date": new Date("{{ post.date | date_to_xmlschema }}"),
              "dateFormatted": "{{ post.date | date: site.date_format }}",
              "excerpt": "{{ post.excerpt | replace: '"', '\"' | normalize_whitespace }}",
              "postHtml": {{postHtml | strip_newlines | jsonify}}
            }{% unless forloop.last %},{% endunless %}
          {% endfor %}
        ];

        postsPaginateSecondaryObject["{{subsectorSlug}}"] = [];
        postsPaginateMainObject["{{subsectorSlug}}"].forEach(function(post, pIndex) {
          post.states.forEach(function(state, index){
            var newPost = {
              "id": post.id,
              "title": post.title,
              "states": post.states,
              "sectors": post.sectors,
              "state": state,
              "subsectors": post.subsectors,
              "url": post.url,
              "date": post.date,
              "dateFormatted": post.dateFormatted,
              "excerpt": post.excerpt,
              "postHtml": post.postHtml
            };
            postsPaginateSecondaryObject["{{subsectorSlug}}"].push(newPost);

            // Increment Total
            postsPaginateSecondaryTotal[state]["{{subsectorSlug}}"] = postsPaginateSecondaryTotal[state]["{{subsectorSlug}}"] + 1 || 1;
          });
        });
      </script>
    {% endfor %}
  {% endfor %}



  <!-- If there are no articles -->
  {% else %}
  <p>There are currently no related articles in this sector.</p>
  {% endif %}

<script>
  console.log(postsPaginateMainObject);
  console.log(postsPaginateSecondaryObject);
  console.log(postsPaginateSecondaryTotal);
</script>

<script src="{{ "/assets/js/pagination.js" | relative_url }}"></script>