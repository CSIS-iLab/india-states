<!-- Get the posts first, and then display them according to subsector -->
{% assign sectorPosts = include.posts | where_exp:"post","post.sectors contains include.sector" %}
{% assign subsectors = site.subsectors | where_exp:"subsector","subsector.sector == include.sector" %}

<!-- Archive Link -->
{% capture archiveLink %}{% if include.state %}states/{{ include.state | slugify }}/{{ include.sector | slugify }}{% else %}sectors/{{ include.sector | slugify }}{% endif %}{% endcapture %}

<!-- Display Subsector Filtering if we have articles in this sector -->
{% if sectorPosts %}
  <ul>
    <li><a href="#all" class="subsector-link" data-show-subsector="{{ include.sector | slugify }}-all" data-sector="{{ include.sector | slugify }}">All</button></li>
    {% for subsector in subsectors %}
      <li><a href="#{{ subsector.title | slugify }}" class="subsector-link" data-show-subsector="{{ subsector.title | slugify }}" data-sector="{{ include.sector | slugify }}">{{ subsector.title }}</button></li>
    {% endfor %}
  </ul>
  
  <div class="post-listing" data-sector="{{ include.sector | slugify }}">
    <!-- Display Overall Top 5 Articles -->
    <div class="subsectorContainer active" data-subsector="{{ include.sector | slugify }}-all">
      All<br />
      {% for post in sectorPosts limit: site.sector_overview_post_limit %}
        {% include post-listing-post.html %}
      {% endfor %}
    </div>

    <!-- Display Top 5 Articles Per Subsector -->
    {% for subsector in subsectors %}
    {% assign subsectorPosts = sectorPosts | where_exp:"post","post.subsectors contains subsector.title" %}
    {% assign subsectorSlug = subsector.title | slugify %}
    <div class="subsectorContainer hidden" data-subsector="{{ subsectorSlug }}">
      {{ subsector.title }}<br />

      <div class="sort-attributes-container">
        <a href="#sort=date&amp;order=asc" class="sort-attribute">Date Ascending</a> &middot; 
        <a href="#sort=date&amp;order=desc" class="sort-attribute active">Date Descending</a> &middot; 
        <a href="#sort=state&amp;order=asc" class="sort-attribute">State Ascending</a> &middot; 
        <a href="#sort=state&amp;order=desc" class="sort-attribute">State Descending</a>
      </div>
      <div class="pagination-posts-container"></div>
      <div class="pagination-container"></div>

      <script type="text/javascript">
        // Load all posts JSON for this State / Section
        var postsPaginateMain = [
          {% for post in subsectorPosts %}
            {% capture states %}[{% for state in post.states %}"{{state}}"{% unless forloop.last %},{% endunless %}{% endfor %}]{% endcapture %}
            {% capture sectors %}[{% for sector in post.sectors %}"{{sector}}"{% unless forloop.last %},{% endunless %}{% endfor %}]{% endcapture %}
            {
              "title": "{{ post.title }}",
              "states": {{states}},
              "sectors": {{sectors}},
              "subsectors": "{{subsector.title}}",
              "url": "{{ post.url | relative_url }}",
              "date": new Date("{{ post.date | date_to_xmlschema }}"),
              "excerpt": "{{ post.excerpt | replace: '"', '\"' | normalize_whitespace }}"
            }{% unless forloop.last %},{% endunless %}
          {% endfor %}
        ];

        var postsPaginateSecondary = [];
        postsPaginateMain.forEach(function(post, pIndex) {
          post.states.forEach(function(state, index){
            var newPost = {
              "title": post.title,
              "states": post.states,
              "sectors": post.sectors,
              "state": state,
              "subsectors": post.subsectors,
              "url": post.url,
              "date": post.date,
              "excerpt": post.excerpt
            };
              postsPaginateSecondary.push(newPost);
            });
        });

        var posts_per_page = {{ site.post_archive_posts_per_page }};
      </script>

      <!-- {% for post in subsectorPosts %}
        {% include post-listing-post.html %}
      {% endfor %} -->
    </div>
    {% endfor %}

  <!-- If there are no articles -->
  {% else %}
  <p>There are currently no related articles in this sector.</p>
  {% endif %}
</div>


<script src="{{ "/assets/js/pagination.js" | relative_url }}"></script>